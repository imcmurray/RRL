{% extends "base.html" %}

{% block title %}{{ project.name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('projects_list') }}">Projects</a></li>
                <li class="breadcrumb-item active">{{ project.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="detail-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1>{{ project.name }}</h1>
            <span class="badge badge-status badge-{{ project.status }} me-2">{{ project.status | title }}</span>
            {% if project.client_name %}
            <span class="text-muted">Client: {{ project.client_name }}</span>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <a href="{{ url_for('projects_edit', project_id=project.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil me-1"></i>Edit
                </a>
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    Update Status
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('planning')">Planning</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('design')">Design</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('development')">Development</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('testing')">Testing</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('launched')">Launched</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('maintenance')">Maintenance</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('archived')">Archive</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Description -->
        <div class="detail-section">
            <h5><i class="bi bi-file-text me-2"></i>Description</h5>
            <p>{{ project.description or 'No description provided.' }}</p>
        </div>

        <!-- Team -->
        <div class="detail-section">
            <h5><i class="bi bi-people me-2"></i>Team</h5>
            {% if project.team %}
            <div class="row">
                {% for member in project.team %}
                <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                        <div class="agent-badge agent-{{ member.role | lower | replace(' ', '_') }} me-2">{{ member.role }}</div>
                        <span>{{ member.name }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
                <p class="text-muted">No team members assigned.</p>
            {% endif %}
        </div>

        <!-- Milestones -->
        <div class="detail-section">
            <h5><i class="bi bi-flag me-2"></i>Milestones</h5>
            {% if project.milestones %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Milestone</th>
                            <th>Due Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for milestone in project.milestones %}
                        <tr>
                            <td>{{ milestone.name }}</td>
                            <td>{{ milestone.due_date | datetime if milestone.due_date else '-' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if milestone.completed else 'secondary' }}">
                                    {{ 'Completed' if milestone.completed else 'Pending' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted">No milestones defined.</p>
            {% endif %}
        </div>

        <!-- Testing -->
        <div class="detail-section">
            <h5><i class="bi bi-clipboard-check me-2"></i>Testing</h5>
            {% if project.testers %}
            <div class="mb-3">
                <strong>Assigned Testers:</strong>
                {% for tester in project.testers %}
                <a href="{{ url_for('testers_detail', tester_id=tester.id) }}" class="badge bg-info text-decoration-none me-1">{{ tester.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
            <a href="{{ url_for('testers_list') }}?assign_to={{ project.id }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-person-plus me-1"></i>Assign Testers
            </a>
        </div>

        <!-- Notes -->
        <div class="detail-section">
            <h5><i class="bi bi-sticky me-2"></i>Notes</h5>
            <div class="notes-list">
                {% if project.notes %}
                    {% for note in project.notes | reverse %}
                    <div class="note-item">
                        <p class="mb-1">{{ note.content }}</p>
                        <div class="note-meta">
                            {{ note.author }} - {{ note.timestamp | datetime }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No notes yet.</p>
                {% endif %}
            </div>
            <form action="{{ url_for('projects_add_note', project_id=project.id) }}" method="post" class="mt-3">
                <div class="input-group">
                    <input type="text" name="note" class="form-control" placeholder="Add a note..." required>
                    <input type="hidden" name="author" value="Dashboard User">
                    <button type="submit" class="btn btn-outline-primary">Add Note</button>
                </div>
            </form>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Project Info -->
        <div class="detail-section">
            <h5><i class="bi bi-info-circle me-2"></i>Project Info</h5>
            <table class="table table-sm">
                <tr>
                    <td class="text-muted">Client</td>
                    <td>
                        {% if project.client_id %}
                        <a href="{{ url_for('clients_detail', client_id=project.client_id) }}">{{ project.client_name }}</a>
                        {% else %}
                        Internal Project
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="text-muted">Platforms</td>
                    <td>
                        {% if project.platforms %}
                            {% for p in project.platforms %}
                            <span class="badge bg-secondary">{{ p }}</span>
                            {% endfor %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="text-muted">Start Date</td>
                    <td>{{ project.start_date | datetime if project.start_date else '-' }}</td>
                </tr>
                <tr>
                    <td class="text-muted">Target Launch</td>
                    <td>{{ project.target_date | datetime if project.target_date else '-' }}</td>
                </tr>
                <tr>
                    <td class="text-muted">Created</td>
                    <td>{{ project.created_at | datetime }}</td>
                </tr>
            </table>
        </div>

        <!-- Financials -->
        <div class="detail-section">
            <h5><i class="bi bi-currency-dollar me-2"></i>Financials</h5>
            <table class="table table-sm">
                <tr>
                    <td class="text-muted">Budget</td>
                    <td>{{ project.budget | currency if project.budget else '-' }}</td>
                </tr>
                <tr>
                    <td class="text-muted">Contract Value</td>
                    <td>{{ project.value | currency if project.value else '-' }}</td>
                </tr>
                <tr>
                    <td class="text-muted">Invoiced</td>
                    <td>{{ project.invoiced | currency if project.invoiced else '$0.00' }}</td>
                </tr>
                <tr>
                    <td class="text-muted">Paid</td>
                    <td>{{ project.paid | currency if project.paid else '$0.00' }}</td>
                </tr>
            </table>
            <a href="{{ url_for('finances_invoice_new') }}?project_id={{ project.id }}" class="btn btn-sm btn-outline-success w-100">
                <i class="bi bi-receipt me-1"></i>Create Invoice
            </a>
        </div>

        <!-- Source Idea -->
        {% if project.idea_id %}
        <div class="detail-section">
            <h5><i class="bi bi-lightbulb me-2"></i>Source Idea</h5>
            <a href="{{ url_for('ideas_detail', idea_id=project.idea_id) }}" class="btn btn-sm btn-outline-primary w-100">
                View Original Idea
            </a>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="detail-section">
            <h5><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-outline-info" onclick="runMeeting('project-meeting', '{{ project.name }}')">
                    <i class="bi bi-people me-1"></i>Run Project Meeting
                </button>
                <form action="{{ url_for('projects_delete', project_id=project.id) }}" method="post">
                    <button type="submit" class="btn btn-outline-danger w-100" data-confirm-delete>
                        <i class="bi bi-trash me-1"></i>Delete Project
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<form id="statusForm" action="{{ url_for('projects_update_status', project_id=project.id) }}" method="post" style="display:none;">
    <input type="hidden" name="status" id="statusInput">
</form>

{% endblock %}

{% block scripts %}
<script>
function updateStatus(status) {
    document.getElementById('statusInput').value = status;
    document.getElementById('statusForm').submit();
}
</script>
{% endblock %}
