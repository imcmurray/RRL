{% extends "base.html" %}

{% block title %}{{ agent.name }} Portal{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('agents_list') }}">Agent Portals</a></li>
                <li class="breadcrumb-item active">{{ agent.role }}</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Agent Header -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card content-card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <span class="agent-badge agent-{{ agent.id }} me-3" style="font-size: 1.5rem; padding: 0.75rem 1.5rem;">{{ customizations.role_title or agent.role }}</span>
                    <div>
                        <h1 class="h3 mb-1">{{ customizations.display_name or agent.name }}</h1>
                        <p class="text-muted mb-0">{{ customizations.description or agent.description }}</p>
                    </div>
                </div>
                {% if has_customizations %}
                <span class="badge bg-info"><i class="bi bi-pencil me-1"></i>Customized</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card content-card h-100">
            <div class="card-body">
                <h5 class="mb-3">Quick Actions</h5>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('agent_request_new', agent_id=agent.id) }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>New Feature Request
                    </a>
                    <a href="{{ url_for('agent_settings', agent_id=agent.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-gear me-1"></i>Agent Settings
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if current_tab == 'overview' %}active{% endif %}"
           href="{{ url_for('agent_portal', agent_id=agent.id, tab='overview') }}">
            <i class="bi bi-house me-1"></i>Overview
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if current_tab == 'requests' %}active{% endif %}"
           href="{{ url_for('agent_portal', agent_id=agent.id, tab='requests') }}">
            <i class="bi bi-lightbulb me-1"></i>Feature Requests
            {% if request_stats.pending > 0 %}
            <span class="badge bg-warning">{{ request_stats.pending }}</span>
            {% endif %}
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if current_tab == 'settings' %}active{% endif %}"
           href="{{ url_for('agent_portal', agent_id=agent.id, tab='settings') }}">
            <i class="bi bi-gear me-1"></i>Settings
            {% if has_customizations %}
            <span class="badge bg-info"><i class="bi bi-pencil"></i></span>
            {% endif %}
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if current_tab == 'how-it-works' %}active{% endif %}"
           href="{{ url_for('agent_portal', agent_id=agent.id, tab='how-it-works') }}">
            <i class="bi bi-info-circle me-1"></i>How It Works
        </a>
    </li>
</ul>

<!-- Tab Content -->
{% if current_tab == 'overview' %}
<!-- Overview Tab -->
<!-- Stats Row -->
<div class="row mb-4"
     id="agent-stats"
     hx-get="{{ url_for('htmx_agent_stats', agent_id=agent.id) }}"
     hx-trigger="every 30s"
     hx-swap="innerHTML">
    <div class="col-md-3 col-6 mb-3">
        <div class="card stats-card">
            <div class="card-body finance-metric">
                <div class="value text-primary">{{ request_stats.total }}</div>
                <div class="label">Total Requests</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card stats-card">
            <div class="card-body finance-metric">
                <div class="value text-warning">{{ request_stats.pending }}</div>
                <div class="label">Pending Review</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card stats-card">
            <div class="card-body finance-metric">
                <div class="value text-success">{{ request_stats.approved }}</div>
                <div class="label">Approved</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card stats-card">
            <div class="card-body finance-metric">
                <div class="value text-info">{{ request_stats.implemented }}</div>
                <div class="label">Implemented</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Responsibilities & Metrics -->
    <div class="col-lg-4 mb-4">
        <div class="card content-card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Responsibilities</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for resp in customizations.responsibilities or agent.responsibilities %}
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>{{ resp }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-4">
        <div class="card content-card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Key Metrics</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for metric in customizations.metrics or agent.metrics %}
                    <li class="mb-2">
                        <i class="bi bi-speedometer2 text-primary me-2"></i>{{ metric }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-4">
        <div class="card content-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
            </div>
            <div class="card-body"
                 id="recent-activity"
                 hx-get="{{ url_for('htmx_agent_activity', agent_id=agent.id) }}"
                 hx-trigger="every 30s"
                 hx-swap="innerHTML">
                {% if recent_activity %}
                <ul class="list-unstyled mb-0">
                    {% for activity in recent_activity %}
                    <li class="mb-2 pb-2 border-bottom">
                        <a href="{{ url_for('agent_request_detail', request_id=activity.id) }}" class="text-decoration-none">
                            <strong>{{ activity.title }}</strong>
                        </a>
                        <br>
                        <small class="text-muted">
                            <span class="badge bg-{{ 'warning' if activity.status == 'submitted' else 'info' if activity.status == 'under_review' else 'success' if activity.status in ['approved', 'implemented'] else 'danger' if activity.status == 'rejected' else 'secondary' }}">
                                {{ activity.status | replace('_', ' ') | title }}
                            </span>
                            {{ activity.created_at | datetime }}
                        </small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">No recent activity</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% elif current_tab == 'requests' %}
<!-- Feature Requests Tab -->
<div class="card content-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-lightbulb me-2"></i>Feature Requests
        </h5>
        <div>
            <button class="btn btn-sm btn-outline-secondary me-2"
                    hx-get="{{ url_for('htmx_agent_requests', agent_id=agent.id) }}"
                    hx-target="#requests-table"
                    hx-swap="innerHTML">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <a href="{{ url_for('agent_request_new', agent_id=agent.id) }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus me-1"></i>New Request
            </a>
        </div>
    </div>
    <div class="card-body"
         id="requests-table"
         hx-get="{{ url_for('htmx_agent_requests', agent_id=agent.id) }}"
         hx-trigger="every 60s"
         hx-swap="innerHTML">
        {% if requests %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr>
                        <td>
                            <a href="{{ url_for('agent_request_detail', request_id=req.id) }}">
                                {{ req.title }}
                            </a>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ req.request_type | title }}</span>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'danger' if req.priority == 'critical' else 'warning' if req.priority == 'high' else 'info' if req.priority == 'medium' else 'secondary' }}">
                                {{ req.priority | title }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'warning' if req.status == 'submitted' else 'info' if req.status == 'under_review' else 'success' if req.status in ['approved', 'implemented'] else 'danger' if req.status == 'rejected' else 'secondary' }}">
                                {{ req.status | replace('_', ' ') | title }}
                            </span>
                        </td>
                        <td>{{ req.created_at | date }}</td>
                        <td>
                            <a href="{{ url_for('agent_request_detail', request_id=req.id) }}" class="btn btn-sm btn-outline-primary">
                                View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-lightbulb display-4 text-muted"></i>
            <p class="text-muted mt-2">No feature requests yet</p>
            <a href="{{ url_for('agent_request_new', agent_id=agent.id) }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Submit Your First Request
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% elif current_tab == 'settings' %}
<!-- Settings Tab -->
<div class="row">
    <div class="col-lg-8">
        <div class="card content-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Agent Settings</h5>
                {% if has_customizations %}
                <span class="badge bg-info">Customized</span>
                {% endif %}
            </div>
            <div class="card-body">
                <form action="{{ url_for('agent_settings', agent_id=agent.id) }}" method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="display_name" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="display_name" name="display_name"
                                   value="{{ customizations.display_name }}" placeholder="{{ agent.name }}">
                            <div class="form-text">How this agent's name appears in the dashboard</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="role_title" class="form-label">Role Title</label>
                            <input type="text" class="form-control" id="role_title" name="role_title"
                                   value="{{ customizations.role_title }}" placeholder="{{ agent.role }}">
                            <div class="form-text">Short title shown in badges (e.g., CEO, CFO)</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"
                                  placeholder="{{ agent.description }}">{{ customizations.description }}</textarea>
                        <div class="form-text">What this agent does in your organization</div>
                    </div>

                    <div class="mb-3">
                        <label for="responsibilities" class="form-label">Responsibilities</label>
                        <textarea class="form-control" id="responsibilities" name="responsibilities" rows="4"
                                  placeholder="One responsibility per line">{{ customizations.responsibilities | join('\n') }}</textarea>
                        <div class="form-text">Enter one responsibility per line</div>
                    </div>

                    <div class="mb-3">
                        <label for="metrics" class="form-label">Key Metrics</label>
                        <textarea class="form-control" id="metrics" name="metrics" rows="3"
                                  placeholder="One metric per line">{{ customizations.metrics | join('\n') }}</textarea>
                        <div class="form-text">What this agent tracks and reports on (one per line)</div>
                    </div>

                    <div class="mb-3">
                        <label for="custom_instructions" class="form-label">Custom Instructions</label>
                        <textarea class="form-control" id="custom_instructions" name="custom_instructions" rows="3"
                                  placeholder="Additional context or instructions for AI meetings...">{{ customizations.custom_instructions }}</textarea>
                        <div class="form-text">Extra context provided to the AI during meetings (e.g., "Focus on bootstrapped startups")</div>
                    </div>

                    <hr class="my-4">
                    <h6 class="mb-3"><i class="bi bi-diagram-3 me-2"></i>Reporting Structure</h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="reports_to" class="form-label">Reports To</label>
                            <select class="form-select" id="reports_to" name="reports_to">
                                <option value="Architect" {% if customizations.reports_to == 'Architect' %}selected{% endif %}>Architect (You)</option>
                                {% for aid, ainfo in all_agents.items() %}
                                {% if aid != agent.id %}
                                <option value="{{ ainfo.name }}" {% if customizations.reports_to == ainfo.name %}selected{% endif %}>{{ ainfo.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <div class="form-text">Who this agent reports to in your organization</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="direct_reports" class="form-label">Direct Reports</label>
                            <input type="text" class="form-control" id="direct_reports" name="direct_reports"
                                   value="{{ customizations.direct_reports | join(', ') if customizations.direct_reports else '' }}"
                                   placeholder="e.g., CFO, CITO, Sales">
                            <div class="form-text">Comma-separated list of agents who report to this one</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="collaborates_with" class="form-label">Collaborates With</label>
                        <textarea class="form-control" id="collaborates_with" name="collaborates_with" rows="2"
                                  placeholder="One collaboration per line (e.g., CFO for pricing)">{{ customizations.collaborates_with | join('\n') if customizations.collaborates_with else '' }}</textarea>
                        <div class="form-text">Key collaboration relationships (one per line)</div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Save Changes
                        </button>
                        {% if has_customizations %}
                        <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#resetModal">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset to Defaults
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card content-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Tips</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        Customize the name to match your company's terminology
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        Add custom instructions to tailor AI responses
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        Adjust responsibilities to fit your business model
                    </li>
                    <li class="mb-0">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        Changes affect how the agent appears and responds
                    </li>
                </ul>
            </div>
        </div>

        <div class="card content-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-code me-2"></i>Advanced</h5>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-2">For deeper customization, edit the agent's system prompt:</p>
                <code class="small">agents/{{ agent.id }}.md</code>
                <p class="small text-muted mt-2 mb-0">This file controls how the agent thinks and responds in AI meetings.</p>
            </div>
        </div>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset to Defaults?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will reset all customizations for <strong>{{ agent.name }}</strong> back to the system defaults.</p>
                <p class="text-muted small mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('agent_settings_reset', agent_id=agent.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-warning">Reset to Defaults</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% elif current_tab == 'how-it-works' %}
<!-- How It Works Tab -->
<div class="row">
    <div class="col-lg-8">
        <!-- How This Agent Works -->
        <div class="card content-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cpu me-2"></i>How {{ agent.name }} Works</h5>
            </div>
            <div class="card-body">
                {% if documentation.how_it_works %}
                <div class="agent-docs">
                    {{ documentation.how_it_works | replace('\n\n', '</p><p>') | replace('\n', '<br>') | safe }}
                </div>
                {% else %}
                <p class="text-muted">Documentation not yet available for this agent.</p>
                {% endif %}
            </div>
        </div>

        <!-- Collaboration -->
        <div class="card content-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Collaboration & Reporting</h5>
                <a href="{{ url_for('agent_portal', agent_id=agent.id, tab='settings') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-pencil me-1"></i>Edit
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <h6 class="text-muted mb-2">Reports To</h6>
                        <span class="badge bg-primary fs-6">{{ customizations.reports_to or documentation.collaboration.reports_to if documentation.collaboration else 'Architect' }}</span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h6 class="text-muted mb-2">Direct Reports</h6>
                        {% set direct_reports = customizations.direct_reports if customizations.direct_reports else (documentation.collaboration.direct_reports if documentation.collaboration else []) %}
                        {% if direct_reports %}
                            {% for report in direct_reports %}
                            <span class="badge bg-secondary me-1">{{ report }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">None</span>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        <h6 class="text-muted mb-2">Collaborates With</h6>
                        {% set collaborates = customizations.collaborates_with if customizations.collaborates_with else (documentation.collaboration.collaborates_with if documentation.collaboration else []) %}
                        {% for collab in collaborates %}
                        <div class="small mb-1">{{ collab }}</div>
                        {% endfor %}
                        {% if not collaborates %}
                        <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Access -->
        <div class="card content-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-database me-2"></i>Data Access</h5>
            </div>
            <div class="card-body">
                {% if documentation.data_access %}
                <p class="text-muted mb-3">This agent has access to the following data during meetings:</p>
                <div class="row">
                    {% for data in documentation.data_access %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <i class="bi bi-folder text-primary me-2"></i>{{ data }}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">Data access information not available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Meeting Types -->
        <div class="card content-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Meeting Types</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">This agent participates in:</p>
                {% if documentation.meeting_types %}
                    {% for meeting_type in documentation.meeting_types %}
                    <div class="mb-2">
                        <span class="badge bg-outline-primary border border-primary text-primary">{{ meeting_type }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Meeting information not available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card content-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('agent_request_new', agent_id=agent.id) }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Submit Feature Request
                    </a>
                    <a href="{{ url_for('agent_portal', agent_id=agent.id, tab='requests') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-list-ul me-1"></i>View All Requests
                    </a>
                    <a href="{{ url_for('agent_portal', agent_id=agent.id, tab='settings') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-gear me-1"></i>Customize Agent
                    </a>
                </div>
                <hr class="my-3">
                <p class="text-muted small mb-2">Related Pages:</p>
                <ul class="list-unstyled small mb-0">
                    <li class="mb-1"><a href="{{ url_for('agents_list') }}"><i class="bi bi-robot me-1"></i>All Agent Portals</a></li>
                    <li class="mb-1"><a href="{{ url_for('agent_requests_pending') }}"><i class="bi bi-bell me-1"></i>Pending Requests</a></li>
                    <li><a href="{{ url_for('settings_page') }}"><i class="bi bi-building me-1"></i>Company Settings</a></li>
                </ul>
            </div>
        </div>

        <!-- Feature Request Workflow -->
        <div class="card content-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Request Workflow</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">How feature requests work:</p>
                <ol class="small mb-0">
                    <li class="mb-2"><strong>Submit</strong> - Agent describes what they need</li>
                    <li class="mb-2"><strong>Review</strong> - Architect evaluates the request</li>
                    <li class="mb-2"><strong>Approve/Reject</strong> - Decision with feedback</li>
                    <li class="mb-0"><strong>Implement</strong> - Approved requests are built</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
